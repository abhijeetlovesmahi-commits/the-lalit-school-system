<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Treasury - The Lalit Intl.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --royal-blue: #002366; --gold: #D4AF37; --light-gold: #FDFBF0; }
        body { background-color: var(--light-gold); font-family: 'Georgia', serif; }
        
        .main-content { padding: 40px; max-width: 900px; margin: auto; }
        .royal-card { 
            background: white; border: 1px solid var(--gold); 
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-radius: 8px;
        }
        .royal-btn { 
            background: var(--royal-blue); color: var(--gold); 
            border: 1px solid var(--gold); padding: 12px; 
            font-weight: bold; transition: 0.3s; width: 100%;
        }
        .royal-btn:hover { background: #001a4d; color: #fff; }
        
        .fee-info-box {
            background: #f8f9fa; border-left: 4px solid var(--royal-blue);
            padding: 15px; margin-bottom: 20px;
        }
        .text-gold { color: var(--gold); }
        .text-velvet { color: var(--royal-blue); font-weight: bold; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
</head>
<body>

<div class="main-content">
    <div class="royal-card">
        <h2 class="text-center mb-4 text-velvet"><i class="fas fa-vault me-2"></i>IMPERIAL TREASURY</h2>
        
        <div class="p-4 mb-4" style="background: rgba(0,0,0,0.03); border: 1px dashed var(--gold);">
            <label class="fw-bold mb-2 text-velvet">Locate Student by Unique ID:</label>
            <div class="input-group">
                <input type="number" id="feeRoll" class="form-control border-gold" placeholder="Enter Student ID (e.g. 2024001)">
                <button class="btn btn-dark" onclick="findStudent()">LOCATE SOUL</button>
            </div>
        </div>

        <div id="treasuryForm" style="display: none;">
            <div class="fee-info-box">
                <h5 id="sNameDisplay" class="text-velvet mb-1"></h5>
                <p id="sDetailsDisplay" class="mb-0 text-muted small"></p>
                <hr>
                <div class="row">
                    <div class="col-6"><small>Expected Academic:</small> <b id="expAcademic">₹0</b></div>
                    <div class="col-6"><small>Monthly Transport:</small> <b id="expTransport">₹0</b></div>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="fw-bold">Amount to Collect (₹)</label>
                    <input type="number" id="fAmount" class="form-control" placeholder="Enter Amount">
                </div>
                <div class="col-md-6">
                    <label class="fw-bold">Payment Purpose</label>
                    <input type="text" id="fMonth" class="form-control" placeholder="e.g. Feb Tuition + Bus">
                </div>
            </div>
            
            <div class="mt-4">
                <button class="royal-btn shadow" onclick="submitFee()">RECEIVE GOLD & ISSUE RECORD</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
      authDomain: "the-lalit-d7472.firebaseapp.com",
      projectId: "the-lalit-d7472",
      appId: "1:479237084229:web:31078825739b3c5712ff2c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function findStudent() {
        const id = document.getElementById('feeRoll').value;
        if(!id) return alert("Please enter Student ID!");

        // 1. Find Student
        const sSnap = await db.collection('students').where('uniqueID', '==', Number(id)).get();
        
        if(!sSnap.empty) {
            const s = sSnap.docs[0].data();
            document.getElementById('sNameDisplay').innerText = s.name;
            document.getElementById('sDetailsDisplay').innerText = `Class: ${s.class} | Father: ${s.father} | Transport: ${s.transport}`;
            
            // 2. Fetch Fee Master for this class
            const mDoc = await db.collection('fee_master').doc(s.class).get();
            let academicMonthly = 0;
            if(mDoc.exists) {
                academicMonthly = mDoc.data().tuition || 0;
                document.getElementById('expAcademic').innerText = "₹" + academicMonthly;
            }

            // 3. Fetch Transport Master if applicable
            let transportMonthly = 0;
            if(s.transport === 'Yes' && s.distance) {
                const tDoc = await db.collection('transport_master').doc(s.distance).get();
                if(tDoc.exists) {
                    transportMonthly = tDoc.data().amount || 0;
                }
            }
            document.getElementById('expTransport').innerText = "₹" + transportMonthly;
            
            document.getElementById('treasuryForm').style.display = 'block';
        } else {
            alert("Student not found in the Royal Registry!");
            document.getElementById('treasuryForm').style.display = 'none';
        }
    }

    async function submitFee() {
        const id = document.getElementById('feeRoll').value;
        const amount = document.getElementById('fAmount').value;
        const purpose = document.getElementById('fMonth').value;

        if(!amount || !purpose) return alert("Please enter amount and purpose!");

        try {
            await db.collection('fee_transactions').add({
                studentID: Number(id),
                amount: Number(amount),
                purpose: purpose,
                date: new Date().toLocaleDateString('en-GB'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert("Treasury Updated! Receipt logged in Archives.");
            location.reload();
        } catch (e) {
            alert("Error: " + e.message);
        }
    }
</script>
<script src="menu.js"></script>
</body>
</html>

