<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collect Fees - The Lalit International</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    
    <style>
        :root { --royal-blue: #002366; --gold: #C5A021; --success: #27ae60; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }

        /* UI Controls */
        .collection-card { max-width: 900px; margin: 30px auto; background: white; border-radius: 15px; border-top: 6px solid var(--royal-blue); box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; }
        .due-badge { background: #fff5f5; color: #c0392b; border: 1px solid #c0392b; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 1.2rem; }
        
        #searchSuggestions { background: white; border: 1px solid #ddd; position: absolute; width: 95%; z-index: 1000; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:hover { background: #f8f9fa; color: var(--royal-blue); }

        /* Receipt Design (A5 Portrait) */
        #receiptArea { display: none; }
        .receipt-card {
            width: 148mm; height: 210mm; background: white; border: 4px double var(--gold); padding: 20px;
            margin: 20px auto; position: relative; font-family: 'Playfair Display', serif;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
        }
        .receipt-header { text-align: center; border-bottom: 2px solid var(--royal-blue); padding-bottom: 10px; margin-bottom: 15px; }
        .receipt-table { width: 100%; margin-top: 15px; }
        .receipt-table th, .receipt-table td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
        .receipt-table th { background: var(--royal-blue); color: var(--gold); }

        .btn-pay { background: var(--royal-blue); color: white; padding: 12px; font-weight: bold; border-radius: 50px; width: 100%; transition: 0.3s; }
        .btn-pay:hover { background: #001a4d; transform: scale(1.02); }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            #receiptArea { display: block !important; }
            .receipt-card { margin: 0; border: 2px solid #000; width: 100%; }
        }
    </style>
</head>
<body>

<div class="collection-card no-print">
    <div class="text-center mb-4">
        <img src="logo.png" style="width: 70px;">
        <h2 style="font-family: 'Cinzel'; color: var(--royal-blue);">Collect Student Fees</h2>
    </div>

    <div class="row g-3">
        <div class="col-md-6 position-relative">
            <label class="fw-bold mb-1">Search Student (Name/ID)</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="studentSearch" class="form-control" placeholder="Type name..." oninput="liveSearch()">
            </div>
            <div id="searchSuggestions" class="shadow"></div>
        </div>

        <div class="col-md-6">
            <label class="fw-bold mb-1">Current Outstanding Balance</label>
            <div id="dueAmount" class="due-badge">₹ 0.00</div>
        </div>

        <hr>

        <div class="col-md-4">
            <label class="fw-bold">Amount Paying</label>
            <input type="number" id="payAmt" class="form-control form-control-lg border-primary" placeholder="Enter Amount">
        </div>
        <div class="col-md-4">
            <label class="fw-bold">Payment Month</label>
            <select id="payMonth" class="form-select form-select-lg">
                <option value="April">April</option><option value="May">May</option><option value="June">June</option>
                <option value="July">July</option><option value="August">August</option><option value="September">September</option>
                <option value="October">October</option><option value="November">November</option><option value="December">December</option>
                <option value="January">January</option><option value="February">February</option><option value="March">March</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="fw-bold">Mode</label>
            <select id="payMode" class="form-select form-select-lg">
                <option value="Cash">Cash</option>
                <option value="Online (UPI/Card)">Online</option>
                <option value="Cheque">Cheque</option>
            </select>
        </div>

        <div class="col-12 mt-4">
            <button class="btn btn-pay" onclick="submitPayment()">
                <i class="fas fa-check-circle me-2"></i> SUBMIT PAYMENT & GENERATE RECEIPT
            </button>
        </div>
    </div>
</div>

<div id="receiptArea"></div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script src="firebase-config.js"></script>

<script>
let activeStudent = null;
let currentBalance = 0;

async function liveSearch() {
    const val = document.getElementById('studentSearch').value.toLowerCase();
    const sugg = document.getElementById('searchSuggestions');
    if(val.length < 2) { sugg.style.display='none'; return; }

    const snap = await db.collection('students').get();
    let html = '';
    snap.forEach(doc => {
        const d = doc.data();
        if(d.name.toLowerCase().includes(val) || d.uniqueID.toString().includes(val)) {
            html += `<div class="suggestion-item" onclick='selectStudent(${JSON.stringify(d)})'>
                        <b>${d.name}</b> (${d.uniqueID}) - Class ${d.class}
                     </div>`;
        }
    });
    sugg.innerHTML = html;
    sugg.style.display = html ? 'block' : 'none';
}

async function selectStudent(s) {
    activeStudent = s;
    document.getElementById('studentSearch').value = s.name;
    document.getElementById('searchSuggestions').style.display = 'none';
    
    // Calculate Balance
    const mDoc = await db.collection('fee_master').doc(s.class).get();
    const tSnap = await db.collection('fee_transactions').where('studentID', '==', String(s.uniqueID)).get();
    
    const fm = mDoc.data();
    let paid = 0; tSnap.forEach(d => paid += Number(d.data().amount));
    
    // Estimate expected dues till current month
    const curMonthIdx = new Date().getMonth(); 
    const mList = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
    const monthName = new Date().toLocaleString('en-us', {month:'long'});
    const mIdx = mList.indexOf(monthName) === -1 ? 11 : mList.indexOf(monthName);

    const monthly = Number(fm.tuition||0) + (s.hostel==='Yes'?Number(fm.hostel||0):0) + (s.transport==='Yes'?500:0);
    const annual = Number(fm.admission||0) + Number(fm.development||0) + Number(fm.exam||0);
    
    const expected = annual + (monthly * (mIdx + 1));
    currentBalance = expected - paid;
    
    document.getElementById('dueAmount').innerText = `₹ ${currentBalance.toFixed(2)}`;
}

async function submitPayment() {
    if(!activeStudent) return alert("Please select a student!");
    const amt = document.getElementById('payAmt').value;
    const month = document.getElementById('payMonth').value;
    const mode = document.getElementById('payMode').value;
    
    if(!amt || amt <= 0) return alert("Enter valid amount!");

    const transID = "TXN" + Date.now();
    const paymentData = {
        studentID: String(activeStudent.uniqueID),
        name: activeStudent.name,
        amount: Number(amt),
        month: month,
        mode: mode,
        date: new Date().toLocaleDateString('en-GB'),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('fee_transactions').add(paymentData);
    
    generateReceipt(paymentData, activeStudent);
    alert("Payment Successful! Receipt Generated.");
    document.getElementById('payAmt').value = "";
}

function generateReceipt(p, s) {
    const receipt = `
    <div class="receipt-card">
        <div class="receipt-header">
            <img src="logo.png" style="width: 50px;">
            <h2 style="font-family:'Cinzel'; color:var(--royal-blue); margin:0;">THE LALIT INTERNATIONAL SCHOOL</h2>
            <p style="font-size:12px; margin:0;">Official Fee Receipt | Session 2025-26</p>
        </div>

        <div class="d-flex justify-content-between mb-3" style="font-size:13px;">
            <span><b>Receipt No:</b> REC-${Date.now().toString().slice(-6)}</span>
            <span><b>Date:</b> ${p.date}</span>
        </div>

        <table class="receipt-table">
            <tr><td><b>Student Name</b></td><td>${s.name.toUpperCase()}</td></tr>
            <tr><td><b>Admission ID</b></td><td>${s.uniqueID}</td></tr>
            <tr><td><b>Class & Section</b></td><td>${s.class} - ${s.section || 'A'}</td></tr>
            <tr><td><b>Father's Name</b></td><td>${s.father}</td></tr>
            <tr><td><b>Payment Month</b></td><td>${p.month}</td></tr>
            <tr><td><b>Payment Mode</b></td><td>${p.mode}</td></tr>
        </table>

        <div class="mt-4 p-3" style="background:var(--royal-blue); color:var(--gold); display:flex; justify-content:space-between; border-radius:8px;">
            <h4 class="mb-0">AMOUNT RECEIVED:</h4>
            <h4 class="mb-0">₹ ${p.amount}</h4>
        </div>

        <p class="mt-3 small"><b>Balance Remaining:</b> ₹ ${(currentBalance - p.amount).toFixed(2)}</p>

        <div class="mt-5 d-flex justify-content-between" style="font-size:12px;">
            <div class="text-center" style="border-top:1px solid #000; width:120px; padding-top:5px;">Depositor Sign</div>
            <div class="text-center" style="border-top:1px solid #000; width:120px; padding-top:5px;">Office Seal/Sign</div>
        </div>

        <div class="text-center no-print mt-4">
            <button class="btn btn-dark btn-sm me-2" onclick="window.print()">Print Receipt</button>
            <button class="btn btn-success btn-sm" onclick="shareReceiptWhatsApp('${s.phone}', '${s.name}', '${p.amount}', '${p.month}')">Share on WhatsApp</button>
        </div>
    </div>`;
    
    document.getElementById('receiptArea').innerHTML = receipt;
    document.getElementById('receiptArea').style.display = 'block';
    window.scrollTo(0, document.body.scrollHeight);
}

function shareReceiptWhatsApp(phone, name, amt, month) {
    const msg = `*THE LALIT INTERNATIONAL SCHOOL*%0A*FEE RECEIPT*%0A%0AHello, We have successfully received *₹${amt}* for *${name}* (Month: ${month}).%0A%0A_Thank you for your payment!_`;
    window.open(`https://wa.me/91${phone}?text=${msg}`, '_blank');
}
</script>
</body>
</html>
