<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Fee Management System</title>
    <style>
        :root { 
            --royal-blue: #002366; 
            --gold: #D4AF37; 
            --danger: #c0392b; 
            --light-gold: #fcf8e3;
        }
        
        body { background: #f0f2f5; margin: 0; padding: 0; font-family: 'Georgia', serif; }

        /* --- Main Page Header & Logo --- */
        .main-header {
            background: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .main-logo { height: 120px; margin-bottom: 15px; }

        .no-print-zone {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        .search-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr; 
            gap: 15px; 
            margin: 20px 0; 
        }

        input, select { padding: 12px; border: 2px solid #eee; border-radius: 6px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--gold); }
        
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-gen { background: var(--royal-blue); color: var(--gold); }
        
        /* Golden Print Button */
        .btn-print { 
            background: var(--gold); 
            color: var(--royal-blue); 
            width: 100%; 
            margin-top: 15px; 
            font-size: 1.1rem; 
            border: 2px solid var(--royal-blue);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-print:hover { background: #e5c158; color: #000; }

        /* --- Slip Print Layout (2 Slips per A4) --- */
        #printArea { max-width: 850px; margin: 0 auto; }

        .slip-container {
            background: white;
            padding: 25px;
            border: 3px double var(--royal-blue);
            box-sizing: border-box;
            position: relative;
            height: 520px; /* Fits 2 on A4 */
            margin-bottom: 5px;
        }

        /* Scissor/Cut Line */
        .cut-line {
            width: 100%;
            height: 30px;
            border-top: 2px dashed #888;
            position: relative;
            margin: 10px 0;
            text-align: center;
        }
        .cut-line::after { content: '‚úÇ Cutting Line'; color: #888; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #f0f2f5; padding: 0 10px; font-size: 0.8rem; }

        .header-flex { display: flex; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
        .slip-logo { height: 70px; margin-right: 15px; }
        .student-photo { width: 90px; height: 110px; border: 2px solid var(--gold); margin-left: auto; object-fit: cover; background: #eee; }
        
        .details-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1rem; }
        .details-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        
        .amount-section { background: var(--light-gold); padding: 15px; border-radius: 5px; border: 1px solid var(--gold); }
        .amount-row { font-size: 1.25rem; font-weight: bold; color: var(--danger); display: flex; justify-content: space-between; margin-top: 5px; }

        .footer-signs { display: flex; justify-content: space-between; margin-top: 45px; font-size: 0.9rem; font-weight: bold; }

        @media print {
            .no-print-zone, .main-header, .cut-line:nth-last-child(1) { display: none; }
            body { background: white; }
            .cut-line { display: block !important; }
            .slip-container {
                height: 49vh; 
                margin: 0;
                page-break-inside: avoid;
                border: 2px solid #000;
            }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="main-header">
    <img src="logo.png" class="main-logo" alt="The Lalit Logo">
    <h1 style="margin:0; color:var(--royal-blue); font-size: 2.5rem;">THE LALIT INTERNATIONAL SCHOOL</h1>
    <p style="color:var(--gold); font-size: 1.2rem; font-weight: bold; letter-spacing: 2px;">FEE DEMAND PORTAL</p>
</div>

<div class="no-print-zone">
    <div class="search-grid">
        <input type="text" id="searchVal" placeholder="Search by ID, Name or Father Name...">
        <select id="classSelect">
            <option value="">-- All Classes --</option>
            <option value="Pre-Nursery">Pre-Nursery</option>
            <option value="Nursery">Nursery</option>
            <option value="LKG">LKG</option>
            <option value="UKG">UKG</option>
            <option value="1">Class 1</option>
            <option value="2">Class 2</option>
            <option value="3">Class 3</option>
            <option value="4">Class 4</option>
            <option value="5">Class 5</option>
            <option value="6">Class 6</option>
            <option value="7">Class 7</option>
            <option value="8">Class 8</option>
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
        </select>
        <button class="btn btn-gen" onclick="processSlips()">GENERATE SLIPS</button>
    </div>
    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è PRINT / DOWNLOAD ALL SLIPS (PDF)</button>
</div>

<div id="printArea">
    </div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function processSlips() {
    const searchVal = document.getElementById('searchVal').value.trim().toLowerCase();
    const className = document.getElementById('classSelect').value;
    const printArea = document.getElementById('printArea');
    
    printArea.innerHTML = "<h2 style='text-align:center'>Generating... Please wait.</h2>";

    let students = [];
    const snap = await db.collection('students').get();

    snap.forEach(doc => {
        const d = doc.data();
        const sid = String(doc.id);
        const sName = (d.name || "").toLowerCase();
        const fName = (d.father || "").toLowerCase();

        let match = false;
        if (searchVal) {
            if (sid === searchVal || sName.includes(searchVal) || fName.includes(searchVal)) match = true;
        } else if (className) {
            if (d.class === className) match = true;
        } else {
            match = true; // All students if no filter
        }

        if (match) students.push({id: doc.id, ...d});
    });

    if (students.length === 0) {
        printArea.innerHTML = "<h3 style='color:red; text-align:center;'>No records found.</h3>";
        return;
    }

    printArea.innerHTML = "";
    for (let i = 0; i < students.length; i++) {
        await renderSlip(students[i]);
        if (i % 2 === 0 && i !== students.length - 1) {
            printArea.innerHTML += `<div class="cut-line"></div>`;
        }
    }
}

async function renderSlip(student) {
    const mDoc = await db.collection('fee_master').doc(student.class).get();
    if(!mDoc.exists) return;
    const master = mDoc.data();

    const tSnap = await db.collection('fee_transactions').where('studentID', '==', Number(student.id)).get();
    let paid = 0;
    tSnap.forEach(doc => paid += Number(doc.data().amount));

    let expected = (master.admission || 0) + (master.tuition || 0) + (master.development || 0);
    if(student.hostel === 'Yes') expected += (master.hostel || 0);
    if(student.transport === 'Yes') expected += (master.transport || 0);
    const balance = expected - paid;

    const slipHtml = `
    <div class="slip-container">
        <div class="header-flex">
            <img src="logo.png" class="slip-logo" onerror="this.src='https://via.placeholder.com/70?text=LOGO'">
            <div>
                <h2 style="margin:0; color:var(--royal-blue); font-size: 1.5rem;">THE LALIT INTERNATIONAL SCHOOL</h2>
                <div style="background:var(--royal-blue); color:var(--gold); display:inline-block; padding:2px 10px; font-weight:bold; margin-top:5px; font-size:0.8rem;">
                    OFFICIAL FEE DUE NOTICE
                </div>
            </div>
            <img src="${student.photo || 'https://via.placeholder.com/90x110?text=Photo'}" class="student-photo">
        </div>

        <table class="details-table">
            <tr>
                <td><b>Student ID:</b> ${student.uniqueID || student.id}</td>
                <td style="text-align:right;"><b>Date:</b> ${new Date().toLocaleDateString()}</td>
            </tr>
            <tr>
                <td><b>Student Name:</b> ${student.name}</td>
                <td style="text-align:right;"><b>Class:</b> ${student.class}</td>
            </tr>
            <tr>
                <td colspan="2"><b>Father's Name:</b> ${student.father}</td>
            </tr>
        </table>

        <div class="amount-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>Total Annual Applicable Fee:</span> <span>‚Çπ${expected}</span>
            </div>
            <div style="display:flex; justify-content:space-between; color:green; margin-bottom:10px;">
                <span>Total Amount Received:</span> <span>- ‚Çπ${paid}</span>
            </div>
            <div class="amount-row">
                <span>NET PAYABLE BALANCE:</span>
                <span>‚Çπ${balance}</span>
            </div>
        </div>

        <p style="font-size: 0.8rem; text-align:center; color:#666; margin-top:15px;">
            Please ignore if already paid. Contact office for any discrepancies.
        </p>

        <div class="footer-signs">
            <div style="border-top:1.5px solid #333; width:160px; text-align:center; padding-top:5px;">Parent's Signature</div>
            <div style="border-top:1.5px solid #333; width:160px; text-align:center; padding-top:5px;">Authorized Accountant</div>
        </div>
    </div>`;
    
    document.getElementById('printArea').innerHTML += slipHtml;
}
</script>
</body>
</html>
