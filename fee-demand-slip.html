<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Royal A5 Slips</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --royal-blue: #002366; --gold-foil: #a67c00; --soft-gold: #f4e4bc; }
        body { background: #d1d4d9; font-family: 'Montserrat', sans-serif; margin: 0; }

        .admin-panel { 
            max-width: 1000px; margin: 20px auto; background: #fff; padding: 20px; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-bottom: 5px solid var(--royal-blue);
        }
        
        /* THE ROYAL SLIP - A5 SIZE LOGIC */
        .slip-card {
            background: #fff; width: 210mm; height: 148mm; /* Half of A4 */
            padding: 25px 35px; position: relative; overflow: hidden;
            border-bottom: 1px dashed #aaa; /* Cut line for A4 */
            box-sizing: border-box;
            page-break-inside: avoid;
        }

        /* Micro-Text Watermark */
        .slip-card::before {
            content: "THE LALIT INTERNATIONAL SCHOOL ";
            position: absolute; top: 0; left: 0; width: 200%; height: 200%;
            font-size: 4px; color: rgba(0,0,0,0.03); line-height: 12px;
            transform: rotate(-15deg); pointer-events: none; z-index: 0;
        }

        .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold-foil); padding-bottom: 10px; margin-bottom: 15px; position: relative; z-index: 2; }
        .school-name { font-family: 'Cinzel', serif; color: var(--royal-blue); font-size: 22px; margin: 0; }
        
        .photo-frame {
            width: 80px; height: 100px; padding: 4px;
            background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2); border-radius: 2px;
        }
        .student-photo { width: 100%; height: 100%; object-fit: cover; background: white; }

        .student-info { flex-grow: 1; padding-left: 20px; position: relative; z-index: 2; }
        .student-info h3 { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--royal-blue); margin-bottom: 2px; }
        
        .fee-table { width: 100%; border-collapse: collapse; margin-top: 10px; position: relative; z-index: 2; }
        .fee-table th { background: var(--royal-blue); color: #fff; padding: 6px; border: 1px solid #000; font-size: 10px; text-transform: uppercase; }
        .fee-table td { padding: 5px; border: 1px solid #000; font-size: 9px; font-weight: 600; }

        .total-banner { 
            background: linear-gradient(to right, var(--royal-blue), #004080); color: #fff; 
            padding: 10px 20px; margin-top: 15px; display: flex; justify-content: space-between;
            align-items: center; border-left: 6px solid var(--gold-foil); position: relative; z-index: 2;
        }
        .total-banner span:last-child { font-family: 'Cinzel', serif; font-size: 24px; color: var(--soft-gold); }

        @media print {
            @page { size: A4 portrait; margin: 0; }
            .no-print { display: none !important; }
            body { background: white; }
            .slip-card { border-bottom: 1px dashed #000; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="admin-panel no-print">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="school-name">ROYAL FEE DEMAND (A4 - 2 Slips)</h2>
        <button class="btn btn-dark btn-sm" onclick="window.print()"><i class="fas fa-print"></i> PRINT</button>
    </div>
    <div class="row g-2">
        <div class="col-md-3">
            <select id="monthSelect" class="form-select border-dark">
                <script>
                    const mList = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
                    mList.forEach(m => document.write(`<option value="${m}">${m}</option>`));
                </script>
            </select>
        </div>
        <div class="col-md-2">
            <select id="classSelect" class="form-select border-dark">
                <option value="">All Classes</option>
                <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
            </select>
        </div>
        <div class="col-md-2">
            <select id="sectionSelect" class="form-select border-dark">
                <option value="">All Sec</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" id="searchID" class="form-control border-dark" placeholder="Name/ID">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100 fw-bold" onclick="fetchAndGenerate()">GENERATE</button>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function fetchAndGenerate() {
    const area = document.getElementById('printArea');
    const targetMonth = document.getElementById('monthSelect').value;
    const targetClass = document.getElementById('classSelect').value;
    const targetSec = document.getElementById('sectionSelect').value;
    const searchVal = document.getElementById('searchID').value.toLowerCase();
    
    area.innerHTML = "<h5 class='text-center mt-5'>Generating Slips...</h5>";

    const [mSnap, tSnap, sSnap] = await Promise.all([
        db.collection('fee_master').get(),
        db.collection('fee_transactions').get(),
        db.collection('students').get()
    ]);

    const masters = {}; mSnap.forEach(d => masters[d.id] = d.data());
    const allTrans = []; tSnap.forEach(d => allTrans.push(d.data()));
    let html = "";
    const targetMonthIdx = mList.indexOf(targetMonth);

    sSnap.forEach(doc => {
        const s = doc.data();
        if (targetClass && s.class != targetClass) return;
        if (targetSec && s.section != targetSec) return;
        if (searchVal && !s.name.toLowerCase().includes(searchVal)) return;

        const m = masters[s.class];
        if(!m) return;

        const monthlyFee = Number(m.tuition||0) + (s.hostel==='Yes'?Number(m.hostel||0):0) + (s.transport==='Yes'?500:0);
        const annualCharge = Number(m.admission||0) + Number(m.development||0) + Number(m.exam||0);

        let totalDemand = annualCharge + (monthlyFee * (targetMonthIdx + 1));
        let totalPaidOverall = allTrans.filter(t => String(t.studentID) === String(s.uniqueID)).reduce((a, b) => a + Number(b.amount), 0);
        
        let prevDemand = annualCharge + (monthlyFee * targetMonthIdx);
        let prevPaid = allTrans.filter(t => String(t.studentID) === String(s.uniqueID) && mList.indexOf(t.month) < targetMonthIdx && t.month !== "Registration").reduce((a, b) => a + Number(b.amount), 0);
        prevPaid += allTrans.filter(t => String(t.studentID) === String(s.uniqueID) && ["Admission", "Annual", "Registration"].includes(t.month)).reduce((a, b) => a + Number(b.amount), 0);
        
        let arrears = prevDemand - prevPaid;
        let currentMonthPaid = allTrans.filter(t => String(t.studentID) === String(s.uniqueID) && t.month === targetMonth).reduce((a, b) => a + Number(b.amount), 0);
        let netPayable = totalDemand - totalPaidOverall;

        html += `
        <div class="slip-card">
            <div class="header-section">
                <img src="logo.png" style="width: 55px;">
                <div class="text-end">
                    <h2 class="school-name">THE LALIT INTERNATIONAL SCHOOL</h2>
                    <div style="font-weight:600; font-size:9px; color:var(--gold-foil); letter-spacing:1px;">FEE DEMAND STATEMENT | UP-TO ${targetMonth.toUpperCase()}</div>
                </div>
            </div>

            <div class="d-flex position-relative" style="z-index:2;">
                <div class="photo-frame"><img src="${s.photo || ''}" class="student-photo"></div>
                <div class="student-info">
                    <h3>${s.name.toUpperCase()}</h3>
                    <div class="row g-0" style="font-size:11px; color:#333;">
                        <div class="col-4"><b>ID:</b> ${s.uniqueID}</div>
                        <div class="col-4"><b>Class:</b> ${s.class}-${s.section || 'A'}</div>
                        <div class="col-4 text-end"><b>Date:</b> ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                </div>
            </div>

            <table class="fee-table">
                <thead>
                    <tr><th>Description</th><th class="text-end">Balance (INR)</th></tr>
                </thead>
                <tbody>
                    <tr><td>Previous Outstanding Dues</td><td class="text-end">₹${arrears}</td></tr>
                    <tr><td>Current Month Fees (${targetMonth})</td><td class="text-end">₹${monthlyFee}</td></tr>
                    <tr style="color:green;"><td>Credits Received (Current Cycle)</td><td class="text-end">- ₹${currentMonthPaid}</td></tr>
                </tbody>
            </table>

            <div class="total-banner">
                <span>Net Payable Amount</span>
                <span>₹${netPayable > 0 ? netPayable : 0}</span>
            </div>

            <div class="mt-3 d-flex justify-content-between align-items-end" style="position:relative; z-index:2;">
                <div style="font-size:8px; color:#555; width:70%;">* This is a computer generated advisory. Please clear the dues to avoid late penalties.</div>
                <div class="text-center" style="width:120px; border-top:1px solid #000; font-size:9px; font-weight:bold;">AUTHORISED SIGNATORY</div>
            </div>
        </div>`;
    });
    area.innerHTML = html || "<h4 class='text-center mt-5'>No Pending Records Found.</h4>";
}
</script>
</body>
</html>
