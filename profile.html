<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - The Lalit Intl.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --royal-blue: #002366; --gold: #D4AF37; --light-gold: #FDFBF0; }
        body { background: var(--light-gold); font-family: 'Georgia', serif; }

        .profile-card { 
            background: white; border-radius: 15px; padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--royal-blue);
            margin-top: 20px;
        }
        .p-photo { 
            width: 160px; height: 180px; border-radius: 10px; 
            object-fit: cover; border: 3px solid var(--gold); 
            background: #eee;
        }
        .section-header { 
            color: var(--royal-blue); border-bottom: 2px solid var(--gold);
            padding-bottom: 5px; margin-bottom: 20px; font-weight: bold;
        }
        .edit-input { display: none; }
        .data-label { font-size: 0.8rem; color: #666; margin-bottom: 2px; }
        .data-value { font-weight: bold; color: #333; margin-bottom: 15px; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="main-content container py-5">
    <button onclick="window.history.back()" class="btn btn-outline-dark mb-4">
        <i class="fas fa-arrow-left"></i> Back to List
    </button>
    
    <div class="profile-card">
        <div class="row">
            <div class="col-md-4 text-center border-end">
                <img id="pPhoto" src="https://via.placeholder.com/150" class="p-photo mb-3">
                <h4 id="pNameDisp" class="text-uppercase fw-bold text-velvet">---</h4>
                <div class="badge bg-dark text-gold p-2 fs-6" id="pIdDisp">ID: --</div>
            </div>

            <div class="col-md-8 ps-md-5">
                <h5 class="section-header"><i class="fas fa-user-graduate me-2"></i>STUDENT ARCHIVE</h5>
                
                <div class="row">
                    <div class="col-6">
                        <p class="data-label">Father's Name</p>
                        <div id="pFatherDisp" class="data-value fw-bold">--</div>
                        <input type="text" id="editFather" class="form-control edit-input mb-3">
                    </div>
                    <div class="col-6">
                        <p class="data-label">Mobile Number</p>
                        <div id="pMobileDisp" class="data-value fw-bold">--</div>
                        <input type="tel" id="editMobile" class="form-control edit-input mb-3">
                    </div>
                    <div class="col-6">
                        <p class="data-label">Current Class</p>
                        <div id="pClassDisp" class="data-value fw-bold">--</div>
                        <select id="editClass" class="form-control edit-input mb-3">
                            <option value="Nursery">Nursery</option>
                            <option value="LKG">LKG</option>
                            <option value="UKG">UKG</option>
                            <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                        </select>
                    </div>
                    <div class="col-6">
                        <p class="data-label">Date of Birth</p>
                        <div id="pDobDisp" class="data-value fw-bold">--</div>
                        <input type="date" id="editDob" class="form-control edit-input mb-3">
                    </div>
                </div>

                <div class="mt-4 pt-3 border-top">
                    <button id="btnEdit" onclick="toggleEdit(true)" class="btn btn-warning px-4 fw-bold">
                        <i class="fas fa-edit"></i> EDIT PROFILE
                    </button>
                    <button id="btnSave" onclick="saveData()" class="btn btn-success edit-input px-4 fw-bold">
                        <i class="fas fa-save"></i> SAVE CHANGES
                    </button>
                    <button id="btnCancel" onclick="toggleEdit(false)" class="btn btn-secondary edit-input ms-2">Cancel</button>
                    
                    <button onclick="deleteStudent()" class="btn btn-danger float-end px-4">
                        <i class="fas fa-trash"></i> DELETE
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs", 
        authDomain: "the-lalit-d7472.firebaseapp.com", 
        projectId: "the-lalit-d7472", 
        appId: "1:479237084229:web:31078825739b3c5712ff2c" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get Student uniqueID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const studentUID = urlParams.get('id'); 
    let docRefId = null; // Store Firestore Document ID

    async function loadData() {
        if(!studentUID) return;

        try {
            const q = await db.collection('students').where('uniqueID', '==', Number(studentUID)).get();
            
            if(!q.empty) {
                const doc = q.docs[0];
                docRefId = doc.id; // Store for updates
                const s = doc.data();

                document.getElementById('pPhoto').src = s.photo || 'https://via.placeholder.com/150';
                document.getElementById('pNameDisp').innerText = s.name;
                document.getElementById('pIdDisp').innerText = "ID: " + s.uniqueID;
                document.getElementById('pFatherDisp').innerText = s.father;
                document.getElementById('pMobileDisp').innerText = s.mobile;
                document.getElementById('pClassDisp').innerText = s.class;
                document.getElementById('pDobDisp').innerText = s.dob;

                // Fill Edit Inputs
                document.getElementById('editFather').value = s.father;
                document.getElementById('editMobile').value = s.mobile;
                document.getElementById('editClass').value = s.class;
                document.getElementById('editDob').value = s.dob;
            } else {
                alert("Student Record Not Found!");
            }
        } catch (e) { console.error(e); }
    }

    function toggleEdit(isEditing) {
        document.querySelectorAll('.data-value').forEach(el => el.style.display = isEditing ? 'none' : 'block');
        document.querySelectorAll('.edit-input').forEach(el => el.style.display = isEditing ? 'block' : 'none');
        document.getElementById('btnEdit').style.display = isEditing ? 'none' : 'inline-block';
        document.getElementById('btnSave').style.display = isEditing ? 'inline-block' : 'none';
        document.getElementById('btnCancel').style.display = isEditing ? 'inline-block' : 'none';
    }

    async function saveData() {
        if(!docRefId) return;

        const updates = {
            father: document.getElementById('editFather').value,
            mobile: document.getElementById('editMobile').value,
            class: document.getElementById('editClass').value,
            dob: document.getElementById('editDob').value
        };

        try {
            await db.collection('students').doc(docRefId).update(updates);
            alert("Imperial Registry Updated Successfully!");
            location.reload();
        } catch (e) { alert("Error updating: " + e.message); }
    }

    async function deleteStudent() {
        if(confirm("WARNING: This will permanently erase the student from the Registry. Proceed?")) {
            try {
                await db.collection('students').doc(docRefId).delete();
                alert("Record Erased.");
                window.location.href = 'index.html';
            } catch (e) { alert("Delete failed: " + e.message); }
        }
    }

    window.onload = loadData;
</script>

<script src="menu.js"></script>

</body>
</html>
