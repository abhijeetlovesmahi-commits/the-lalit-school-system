<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Login | The Lalit Intl.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --royal-blue: #002366; --gold: #D4AF37; }
        body { 
            background: linear-gradient(135deg, var(--royal-blue) 0%, #001a4d 100%); 
            height: 100vh; display: flex; align-items: center; justify-content: center; font-family: sans-serif;
        }
        .login-card { 
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.4); width: 100%; max-width: 400px; text-align: center;
        }
        .form-control { margin-bottom: 20px; padding: 12px; border-radius: 8px; }
        .btn-login { background: var(--royal-blue); color: var(--gold); font-weight: bold; width: 100%; padding: 12px; border: 1px solid var(--gold); }
        #statusMsg { font-size: 0.85rem; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="login-card">
    <h3 class="fw-bold mb-4" style="color: var(--royal-blue);">STAFF PORTAL</h3>
    <input type="email" id="email" class="form-control" placeholder="Email Address">
    <input type="password" id="pass" class="form-control" placeholder="Password">
    <button class="btn btn-login" id="loginBtn" onclick="processLogin()">AUTHENTICATE SYSTEM</button>
    <div id="statusMsg"></div>
    <hr>
    <a href="index.html" class="text-decoration-none text-muted small"><i class="fas fa-arrow-left"></i> Back to School Website</a>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script src="firebase-config.js"></script>

<script>
    // Ye do lines "auth is not defined" error ko theek karti hain
    const auth = firebase.auth();
    const db = firebase.firestore();

    async function processLogin() {
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('pass').value;
        const msg = document.getElementById('statusMsg');
        const btn = document.getElementById('loginBtn');

        if(!email || !pass) {
            msg.innerHTML = "<span class='text-danger'>Fill all fields!</span>";
            return;
        }

        btn.disabled = true;
        btn.innerText = "VERIFYING...";

        try {
            // STEP 1: Firebase Auth login
            const userCredential = await auth.signInWithEmailAndPassword(email, pass);
            msg.innerHTML = "<span class='text-success'>Access Granted. Loading Dashboard...</span>";

            // STEP 2: Role check in Firestore
            const snap = await db.collection('users').where('email', '==', email.toLowerCase()).get();

            if (!snap.empty) {
                const role = snap.docs[0].data().role;
                // Redirection based on Role
                if (role === 'admin') window.location.href = "dashboard.html";
                else if (role === 'accountant') window.location.href = "collect-fees.html";
                else if (role === 'teacher') window.location.href = "attendance.html";
                else window.location.href = "dashboard.html"; // Default
            } else {
                // Agar Firestore mein nahi hai par Auth mein hai, toh seedha dashboard bhej do
                window.location.href = "dashboard.html";
            }

        } catch (error) {
            btn.disabled = false;
            btn.innerText = "AUTHENTICATE SYSTEM";
            msg.innerHTML = "<span class='text-danger'>Error: " + error.message + "</span>";
        }
    }
</script>
</body>
</html>
