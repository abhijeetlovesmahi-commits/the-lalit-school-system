<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lalit - Marks Entry Master</title>
    <style>
        :root {
            --royal-blue: #002366; --gold: #D4AF37; --deep-gold: #aa8a2e;
            --light-gold: #FDFBF0; --white: #ffffff; --danger: #e74c3c;
        }

        body {
            background: var(--light-gold); margin: 0; padding: 20px;
            font-family: 'Georgia', serif; color: var(--royal-blue);
        }

        .container {
            max-width: 1200px; margin: 0 auto; background: var(--white);
            padding: 30px; border-radius: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid var(--gold);
        }

        .school-header {
            text-align: center; border-bottom: 3px double var(--gold);
            margin-bottom: 20px; padding-bottom: 15px;
        }
        
        .school-logo { width: 100px; margin-bottom: 10px; }

        .filter-section {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; background: #fdfaf0; padding: 20px;
            border: 1px solid var(--gold); margin-bottom: 20px; border-radius: 8px;
        }

        .subject-highlight {
            background: #fff8e1; border: 2px solid var(--gold) !important; font-weight: bold;
        }

        label { font-size: 0.75rem; font-weight: bold; color: var(--deep-gold); text-transform: uppercase; }
        
        select, input {
            width: 100%; padding: 10px; border: 1px solid #ccc;
            border-bottom: 2px solid var(--gold); outline: none;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: var(--royal-blue); color: var(--gold); padding: 12px; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }

        .id-badge { font-size: 0.75rem; color: #666; display: block; margin-top: 2px; }
        .roll-no { font-size: 1.1rem; font-weight: bold; color: var(--royal-blue); }

        .std-img { width: 50px; height: 60px; object-fit: cover; border: 1px solid var(--gold); background: #f0f0f0; }

        .marks-input {
            width: 75px; padding: 8px; text-align: center; border: 2px solid #ddd;
            font-weight: bold; font-size: 1.1rem;
        }

        .marks-input.error { border-color: var(--danger); background-color: #ffdada; color: var(--danger); }
        .hidden { display: none; }

        .submit-btn {
            width: 100%; padding: 20px; background: var(--royal-blue); color: var(--gold);
            border: 1px solid var(--gold); font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 25px;
        }

        #status { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>
</head>
<body>

<div class="container">
    <div class="school-header">
        <img src="logo.png" alt="School Logo" class="school-logo" onerror="this.src='https://via.placeholder.com/100?text=LOGO'">
        <h1 style="font-size: 1.8rem; margin: 5px 0;">STUDENT MARKS ENTRY</h1>
        <p id="currentAction" style="color: var(--danger); font-weight: bold;">Select Subject to Load Full Marks</p>
    </div>

    <div class="filter-section">
        <div>
            <label>Exam Type</label>
            <select id="examType" onchange="toggleTermFields(); fetchSubjects();">
                <option value="">-- Select --</option>
                <option value="Formative Test -I">Formative Test -I</option>
                <option value="Periodic Test -I">Periodic Test -I</option>
                <option value="Term -I">Term -I</option>
                <option value="Formative Test -II">Formative Test -II</option>
                <option value="Periodic -II">Periodic -II</option>
                <option value="Term -II">Term -II</option>
            </select>
        </div>
        <div>
            <label>Class</label>
            <select id="examClass" onchange="fetchSubjects(); fetchStudents();">
                <option value="">-- Select --</option>
                <option value="Pre-Nursery">Pre-Nursery</option>
                <option value="Nursery">Nursery</option>
                <option value="LKG">LKG</option>
                <option value="UKG">UKG</option>
                <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">Class ${i}</option>`);</script>
            </select>
        </div>
        <div>
            <label>Section</label>
            <select id="sSection" onchange="fetchStudents();">
                <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>
        </div>
        <div>
            <label>Subject</label>
            <select id="subjectSelect" class="subject-highlight" onchange="updateMaxMarks(); loadExistingMarks();">
                <option value="">-- Select Subject --</option>
            </select>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Roll & ID</th>
                <th>Photo</th>
                <th style="text-align: left;">Student Name</th>
                <th id="headerMarks">Obtained Marks</th>
                <th class="term-only hidden">Notebook (5)</th>
                <th class="term-only hidden">SEA (5)</th>
            </tr>
        </thead>
        <tbody id="studentBody">
            <tr><td colspan="6">Waiting for selection...</td></tr>
        </tbody>
    </table>

    <button class="submit-btn" onclick="saveMarks()">SAVE ALL MARKS</button>
    <div id="status"></div>
</div>

<script>
let currentMax = 100;

function toggleTermFields() {
    const isTerm = document.getElementById('examType').value.includes("Term");
    document.querySelectorAll('.term-only').forEach(el => isTerm ? el.classList.remove('hidden') : el.classList.add('hidden'));
}

async function fetchSubjects() {
    const eClass = document.getElementById('examClass').value;
    const eType = document.getElementById('examType').value;
    if(!eClass || !eType) return;

    const docId = `${eClass}_${eType}`.replace(/\s+/g, '');
    const doc = await db.collection('exam_settings').doc(docId).get();

    const subSelect = document.getElementById('subjectSelect');
    subSelect.innerHTML = '<option value="">-- Select Subject --</option>';
    if(doc.exists) {
        doc.data().subjects.forEach(sub => {
            subSelect.innerHTML += `<option value="${sub.subjectName}" data-max="${sub.fullMarks}">${sub.subjectName}</option>`;
        });
    }
}

function updateMaxMarks() {
    const sel = document.getElementById('subjectSelect');
    const opt = sel.options[sel.selectedIndex];
    if(sel.value) {
        currentMax = Number(opt.getAttribute('data-max'));
        document.getElementById('headerMarks').innerText = `Marks (Max: ${currentMax})`;
        document.getElementById('currentAction').innerHTML = `Entry for: ${sel.value} | Max Marks: ${currentMax}`;
        validateAll();
    }
}

function validateAll() {
    document.querySelectorAll('.main-m').forEach(input => {
        if(Number(input.value) > currentMax) input.classList.add('error');
        else input.classList.remove('error');
    });
}

async function fetchStudents() {
    const sClass = document.getElementById('examClass').value;
    const sSection = document.getElementById('sSection').value;
    if(!sClass || !sSection) return;

    const tbody = document.getElementById('studentBody');
    tbody.innerHTML = "<tr><td colspan='6'>Loading Students...</td></tr>";

    try {
        const snap = await db.collection('students').where('class', '==', sClass).where('section', '==', sSection).get();
        let students = [];
        snap.forEach(doc => students.push(doc.data()));
        
        students.sort((a, b) => a.uniqueID - b.uniqueID);

        tbody.innerHTML = "";
        students.forEach(s => {
            const isTerm = document.getElementById('examType').value.includes("Term");
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <span class="roll-no">${s.uniqueID - 1000}</span>
                    <span class="id-badge">ID: ${s.uniqueID}</span>
                </td>
                <td><img src="${s.photo || 'https://via.placeholder.com/50'}" class="std-img"></td>
                <td style="text-align: left;"><b>${s.name}</b></td>
                <td><input type="number" class="marks-input main-m" data-id="${s.uniqueID}" oninput="validateAll()"></td>
                <td class="term-only ${isTerm ? '' : 'hidden'}"><input type="number" class="marks-input note-m" max="5"></td>
                <td class="term-only ${isTerm ? '' : 'hidden'}"><input type="number" class="marks-input sea-m" max="5"></td>
            `;
            tbody.appendChild(tr);
        });
        
        if(document.getElementById('subjectSelect').value) {
            loadExistingMarks();
        }
        
    } catch (e) { alert(e.message); }
}

async function loadExistingMarks() {
    const exam = document.getElementById('examType').value;
    const cls = document.getElementById('examClass').value;
    const sec = document.getElementById('sSection').value;
    const subject = document.getElementById('subjectSelect').value;

    if(!exam || !cls || !sec || !subject) return;

    document.getElementById('status').innerHTML = "Checking for existing marks...";

    try {
        const snap = await db.collection('marks_entry')
            .where('class', '==', cls)
            .where('section', '==', sec)
            .where('exam', '==', exam)
            .where('subject', '==', subject)
            .get();

        if(!snap.empty) {
            snap.forEach(doc => {
                const data = doc.data();
                const row = document.querySelector(`.main-m[data-id="${data.uID}"]`);
                if(row) {
                    const parentTr = row.closest('tr');
                    row.value = data.marks;
                    if(parentTr.querySelector('.note-m')) parentTr.querySelector('.note-m').value = data.notebook;
                    if(parentTr.querySelector('.sea-m')) parentTr.querySelector('.sea-m').value = data.sea;
                }
            });
            document.getElementById('status').innerHTML = "<span style='color:blue;'>✓ Existing marks loaded for editing.</span>";
        } else {
            document.querySelectorAll('.marks-input').forEach(i => i.value = "");
            document.getElementById('status').innerHTML = "No previous marks found. Ready for new entry.";
        }
    } catch (e) { console.error("Error loading marks: ", e); }
}

async function saveMarks() {
    const subject = document.getElementById('subjectSelect').value;
    if(!subject) { alert("Select Subject First"); return; }
    if(document.querySelectorAll('.error').length > 0) { alert("Marks cannot be more than " + currentMax); return; }

    const batch = db.batch();
    const rows = document.querySelectorAll('#studentBody tr');
    const exam = document.getElementById('examType').value;
    const cls = document.getElementById('examClass').value;
    const sec = document.getElementById('sSection').value;

    rows.forEach(row => {
        const mainInput = row.querySelector('.main-m');
        if(!mainInput) return;
        
        const uID = mainInput.getAttribute('data-id');
        const m = mainInput.value;
        const n = row.querySelector('.note-m')?.value || 0;
        const s = row.querySelector('.sea-m')?.value || 0;

        const docId = `${cls}_${sec}_${exam}_${subject}_${uID}`.replace(/\s+/g, '');
        batch.set(db.collection('marks_entry').doc(docId), {
            uID, class: cls, section: sec, exam, subject, marks: Number(m), notebook: Number(n), sea: Number(s), timestamp: Date.now()
        });
    });

    try {
        await batch.commit();
        document.getElementById('status').innerHTML = "<span style='color:green;'>✓ Saved/Updated Successfully!</span>";
    } catch (e) { alert(e.message); }
}
</script>
</body>
</html>
